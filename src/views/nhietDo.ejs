<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!----======== CSS ======== -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous"
        />
        <script
            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
            integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
            crossorigin="anonymous"
        ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <link href="/css/nhietDo.css" rel="stylesheet" type="text/css" />
        <link href="/css/pagination.css" rel="stylesheet" type="text/css" />
        <!----===== Boxicons CSS ===== -->
        <link
            href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css"
            rel="stylesheet"
        />
        <!-- gg icon -->

        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0"
        />
        <title>IOT FARM</title>
    </head>
    <body>
        <nav class="sidebar close">
            <header>
                <div class="image-text">
                    <span class="image">
                        <img src="./img/01_logobachkhoasang 1.svg" alt="" />
                    </span>

                    <div class="text logo-text">
                        <span class="name">Hệ thống</span>
                        <span class="profession">Vườn thông minh</span>
                    </div>
                </div>

                <i class="bx bx-chevron-right toggle"></i>
            </header>

            <div class="menu-bar">
                <div class="menu">
                    <li class="search-box">
                        <i class="bx bx-search icon"></i>
                        <input type="text" placeholder="Search..." />
                    </li>

                    <ul class="menu-link">
                        <li class="nav-link">
                            <a href="http://localhost:8080/dashBoard">
                                <i class="bx bx-home-alt icon"></i>
                                <span class="text nav-text"
                                    >Điều khiển động cơ</span
                                >
                            </a>
                        </li>

                        <li class="nav-link">
                            <a href="http://localhost:8080/nhietDo">
                                <!-- <i class="bx bx-bar-chart-alt-2 icon"></i> -->
                                <span class="material-symbols-outlined icon">
                                    device_thermostat
                                </span>
                                <span class="text nav-text">Nhiệt độ</span>
                            </a>
                        </li>

                        <li class="nav-link">
                            <a href="http://localhost:8080/doAmDat">
                                <!-- <i class="bx bx-bell icon"></i> -->
                                <span class="material-symbols-outlined icon">
                                    humidity_mid
                                </span>
                                <span class="text nav-text">Độ ẩm đất</span>
                            </a>
                        </li>

                        <li class="nav-link">
                            <a href="http://localhost:8080/doAmKhongKhi">
                                <!-- <i class="bx bx-pie-chart-alt icon"></i> -->
                                <span class="material-symbols-outlined icon">
                                    humidity_percentage
                                </span>
                                <span class="text nav-text"
                                    >Độ ẩm không khí</span
                                >
                            </a>
                        </li>

                        <li class="nav-link">
                            <a href="http://localhost:8080/anhSang">
                                <span class="material-symbols-outlined icon">
                                    wb_sunny
                                </span>
                                <span class="text nav-text">Ánh sáng</span>
                            </a>
                        </li>

                        <li class="nav-link">
                            <a href="http://localhost:8080/lapLich">
                                <i class="bx bx-wallet icon"></i>
                                <span class="text nav-text"
                                    >Cài đặt thời gian</span
                                >
                            </a>
                        </li>
                        <li class="nav-link">
                            <a href="/nguongCamBien">
                                <i class="material-symbols-outlined icon">
                                    rule_settings
                                </i>
                                <span class="text nav-text"
                                    >Ngưỡng cảm biến</span
                                >
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="bottom-content">
                    <li class="">
                        <a href="#">
                            <i class="bx bx-log-out icon"></i>
                            <span class="text nav-text">Logout</span>
                        </a>
                    </li>

                    <li class="mode">
                        <div class="sun-moon">
                            <i class="bx bx-moon icon moon"></i>
                            <i class="bx bx-sun icon sun"></i>
                        </div>
                        <span class="mode-text text">Dark mode</span>

                        <div class="toggle-switch">
                            <span class="switch"></span>
                        </div>
                    </li>
                </div>
            </div>
        </nav>
        <!-- SECTION -->
        <section class="home">
            <div class="top">
                <div></div>
                <div class="d-flex align-items-center">
                    <span>Vườn 1</span>
                    <span class="material-symbols-outlined"> enable </span>
                </div>
                <div class="dropdown">
                    <button
                        class="btn btn-secondary btn-sm dropdown-toggle"
                        type="button"
                        data-bs-toggle="dropdown"
                        aria-expanded="false"
                    >
                        <img src="./img/people.jpg" alt="" /> admin
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                        <li>
                            <a class="dropdown-item active" href="#"
                                >Thông tin cá nhân</a
                            >
                        </li>
                        <li><a class="dropdown-item" href="#">Thông báo</a></li>
                        <li>
                            <a class="dropdown-item" href="#">Trạng thái</a>
                        </li>
                        <li><hr class="dropdown-divider" /></li>
                        <li><a class="dropdown-item" href="#">Đăng xuất</a></li>
                    </ul>
                </div>
            </div>
            <!-- Thong so -->

            <div class="text">Thông số nhiệt độ</div>

            <!-- Dieu khien -->

            <div class="text">
                <span>Biểu đồ nhiệt độ vườn</span>
                <div class="container">
                    <div class="temp">
                        <div class="infor1">Nhiệt độ hiện tại</div>
                        <div class="chart"></div>
                        <div class="infor2">
                            <span>0</span>
                            <span>50</span>
                        </div>
                    </div>
                    <div class="temp2">
                        <ul class="nums">
                            <li><span> 50</span></li>
                            <li><span> 40</span></li>
                            <li><span> 30</span></li>
                            <li><span> 20</span></li>
                            <li><span> 10</span></li>
                            <li><span> 0</span></li>
                        </ul>
                        <ul class="bars"></ul>
                    </div>
                </div>
            </div>
            <!--  History -->
            <div class="text">Biểu đồ lịch sử</div>
            <div class="m-5">
                <div class="table">
                    <div
                        class="tab_head_container d-flex justify-content-between"
                    >
                        <div class="page-limit d-flex align-items-center">
                            <span style="width: 150px">Hiển thị</span>
                            <select
                                id="table_size"
                                class="form-select"
                                style="width: 80%"
                            >
                                <option selected>size</option>
                                <option value="5">5</option>
                                <option value="8">8</option>
                                <option value="10">10</option>
                            </select>
                        </div>
                        <!-- filter -->
                        <div
                            class="input-group mb-3 tab_filter_container"
                            style="width: 20%"
                        >
                            <input
                                type="text"
                                class="form-control"
                                placeholder="...C"
                                id="tab_filter_text"
                            />
                            <button
                                class="btn btn-outline-secondary active"
                                type="button"
                                id="tab_filter_btn"
                            >
                                Search
                            </button>
                        </div>
                    </div>
                    <table class="table mx-2 text-center" style="width: 90%">
                        <thead>
                            <tr>
                                <th scope="col">Số thứ tự</th>
                                <th scope="col">Nhiệt Độ</th>
                                <th scope="col">Thời gian</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <!-- footer -->
                <div
                    class="footer-pg d-flex justify-content-around align-items-center"
                >
                    <span>Showing 1 to 10 of 60 entries</span>
                    <div class="index_buttons"></div>
                </div>
            </div>
        </section>
        <!-- History -->
        <script>
            // size mảng
            var rankList = [
                {
                    id: 1,
                    value: "30℃",
                    time: "7/12/2021",
                },
                {
                    id: 2,
                    value: "30℃",
                    time: "7/12/2021",
                },
                {
                    id: 3,
                    value: "30℃",
                    time: "7/12/2021",
                },
                {
                    id: 4,
                    value: "36℃",
                    time: "7/12/2021",
                },
                {
                    id: 5,
                    value: "30℃",
                    time: "7/12/2021",
                },
                {
                    id: 6,
                    value: "30℃",
                    time: "7/12/2021",
                },
                {
                    id: 7,
                    value: "33℃",
                    time: "7/12/2021",
                },
                {
                    id: 8,
                    value: "30℃",
                    time: "7/12/2021",
                },
                {
                    id: 9,
                    value: "30℃",
                    time: "7/12/2021",
                },
                {
                    id: 10,
                    value: "35℃",
                    time: "7/12/2021",
                },
                {
                    id: 11,
                    value: "28℃",
                    time: "7/12/2021",
                },
            ];
            var array = [];
            //arr_len = tổng hàng
            var array_length = 0;
            //hiện số hàng
            var table_size = 10;
            var start_index = 1;
            var end_index = 0;
            var curr_index = 1; //button hiện tại
            var max_index = 0; //render nút idx ở footer
            //Tính toán pagination
            function preLoadCalculation() {
                filterRankList();
                //array = rankList;
                array_length = array.length;
                max_index = parseInt(array_length / table_size);
                if (array_length % table_size > 0) {
                    max_index++;
                }
            }
            function filterRankList() {
                var tab_filter_text = $("#tab_filter_text").val();
                if (tab_filter_text != "") {
                    var temp_array = rankList.filter(function (object) {
                        return (
                            object.id.toString().includes(tab_filter_text) ||
                            object.value.toString().includes(tab_filter_text) ||
                            object.time.toString().includes(tab_filter_text)
                        );
                    });
                    array = temp_array;
                } else {
                    array = rankList;
                }
            }
            function displayIndexButtons() {
                //Tính toán func max_value, arr_len, .. trước khi pagination
                preLoadCalculation();
                $(".index_buttons button").remove();
                $(".index_buttons").append(
                    '<button onclick="prev();">Previous</button>'
                );
                for (var i = 1; i <= max_index; i++) {
                    $(".index_buttons").append(
                        '<button onclick="indexPanigation(' +
                            i +
                            ');" index="' +
                            i +
                            '">' +
                            i +
                            "</button>"
                    );
                }
                $(".index_buttons").append(
                    '<button onclick="next();">Next</button>'
                );
                hightlightIndexButton();
            }

            function hightlightIndexButton() {
                start_index = (curr_index - 1) * table_size + 1;
                end_index = start_index + table_size - 1;
                if (end_index > array_length) {
                    end_index = array_length;
                }
                $(".footer-pg span").text(
                    "showing " +
                        start_index +
                        " to " +
                        end_index +
                        " of " +
                        array_length +
                        " entries "
                );
                $(".index_buttons button").removeClass("active");
                //Chon button dựa vào call idx
                $(".index_buttons button[index='" + curr_index + "']").addClass(
                    "active"
                );

                displayTableRows();
            }
            function displayTableRows() {
                $(".table table tbody tr").remove();
                var tab_start = start_index - 1;
                var tab_end = end_index;
                for (var i = tab_start; i < tab_end; i++) {
                    var sensor = array[i];
                    var tr =
                        "<tr>" +
                        '<th scope="row">' +
                        sensor["id"] +
                        "</th>" +
                        "<td>" +
                        sensor["value"] +
                        "</td>" +
                        "<td>" +
                        sensor["time"] +
                        "</td>" +
                        "</tr>";
                    $(".table table tbody").append(tr);
                }
            }
            displayIndexButtons();
            function next() {
                if (curr_index < max_index) {
                    curr_index++;
                    hightlightIndexButton();
                }
            }
            //giam prev if > 1
            function prev() {
                if (curr_index > 1) {
                    curr_index--;
                    hightlightIndexButton();
                }
            }
            function indexPanigation(index) {
                curr_index = parseInt(index);
                hightlightIndexButton();
            }

            $("#table_size").change(function () {
                table_size = parseInt($(this).val());
                curr_index = 1;
                start_index = 1;
                displayIndexButtons();
            });
            $("#tab_filter_btn").click(function () {
                curr_index = 1;
                start_index = 1;
                displayIndexButtons();
            });
        </script>
        <script>
            const body = document.querySelector("body"),
                sidebar = body.querySelector("nav"),
                toggle = body.querySelector(".toggle"),
                searchBtn = body.querySelector(".search-box"),
                modeSwitch = body.querySelector(".toggle-switch"),
                modeText = body.querySelector(".mode-text");

            toggle.addEventListener("click", () => {
                sidebar.classList.toggle("close");
            });

            searchBtn.addEventListener("click", () => {
                sidebar.classList.remove("close");
            });

            modeSwitch.addEventListener("click", () => {
                body.classList.toggle("dark");

                if (body.classList.contains("dark")) {
                    modeText.innerText = "Light mode";
                } else {
                    modeText.innerText = "Dark mode";
                }
            });
        </script>
        <script>
            // call api get latest value
            const tempElenment = document.querySelector(".temp");
            const device = JSON.parse("<%- JSON.stringify(device) %>");
            console.log(device);
            const resLatestValue = fetch(
                `http://localhost:8080/api/activityLog/${device._id}/latest`,
                { method: "GET" }
            )
                .then((res) => {
                    return res.json();
                })
                .then((result) => {
                    tempElenment.style.setProperty(
                        "--value",
                        parseInt(result.value)
                    );
                });
            const username = "nguyentruongthan";
        </script>
        <script>
            //call api get hourly chart
            const barsContainer = document.querySelector(".bars");
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1; // Adding 1 because getMonth() returns zero-based index (0 for January)
            const currentDateOfMonth = currentDate.getDate();
            const currentYear = currentDate.getFullYear();
            const resHourlyChart = fetch(
                `http://localhost:8080/api/activitylog/${device._id}/${currentMonth}-${currentDateOfMonth}-${currentYear}/hourly`,
                { method: "GET" }
            )
                .then((res) => {
                    console.log(res);
                    if (res.ok) {
                        return res.json();
                    } else {
                        return new Array(11).fill(null);
                    }
                })
                .then((result) => {
                    // console.log(result);
                    return result;
                })
                .then((result) => {
                    result.forEach((log, index) => {
                        let bar = "";
                        if (!log) {
                            bar = `
                  <li><div class = "bar" data-percentage= "0"></div><span> ${
                      index * 2
                  }:00</span></li>
                `;
                        } else {
                            bar = ` 
                  <li><div class = "bar" data-percentage= "${
                      log.value
                  }"></div><span> ${index * 2}:00</span></li>
                `;
                        }
                        barsContainer.innerHTML += bar;
                    });
                    var bars = document.querySelectorAll(".bars li .bar");
                    bars.forEach(function (bar) {
                        var percentage = parseFloat(
                            bar.getAttribute("data-percentage")
                        );
                        if (percentage > 0) {
                            // Check if percentage is greater than 0
                            var height = percentage * 7;
                            bar.style.height = height + "px";
                        } else {
                            bar.style.display = "none"; // Hide the bar if percentage is 0
                        }
                    });
                });
        </script>
        <script src="socket.io/socket.io.js"></script>
        <script>
            // socketIO
            const socket = io();
            socket.on(`${username} 2`, (msg) => {
                console.log(msg);
                //message format: header:deviceID:value
                let splitMessage = [];
                if (typeof msg != "string") {
                    const decoder = new TextDecoder("utf-8");
                    const decodedString = decoder.decode(msg);
                    splitMessage = decodedString.split(":");
                } else {
                    splitMessage = msg.split(":");
                }
                const header = splitMessage[0];
                const deviceID = splitMessage[1];
                const value = splitMessage[2];
                if (header === "2") {
                    //HEADER_SENSOR_VALUE
                    if (deviceID === device._id) {
                        tempElenment.style.setProperty(
                            "--value",
                            parseInt(value)
                        );
                    }
                }
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    </body>
</html>
